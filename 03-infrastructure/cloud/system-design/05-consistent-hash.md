### 안정 해시
* 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.
* 안정 해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

**해시 키 재배치 문제**
* N개의 캐시 서버가 있다고 하자. 이 서버들에 부하를 균등하게 나누는 보편적 방법은 `serverIndex = hash(key) % N (N은 서버 개수)`
* 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다.
  * 하지만 서버가 추가, 삭제되면 문제가 생긴다.
  * 키가 재분배되어, 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 되어 캐시 미스가 발생한다.

**문제 상황 예시**
* 서버 3대인 상황
  * 키 A → hash(A) % 3 = 0 (서버 0으로 저장)
  * 키 B → hash(B) % 3 = 1 (서버 1으로 저장)
  * 키 C → hash(C) % 3 = 2 (서버 2로 저장)
* 서버 추가 (서버 4대)
  * 키 A → hash(A) % 4 = 2 (서버 2로 이동)
  * 키 B → hash(B) % 4 = 3 (서버 3으로 이동)
  * 키 C → hash(C) % 4 = 0 (서버 0으로 이동)

**안정 해시**

![img.png](../../assets/images/hash-ring.png)

* 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다. 여기서 k는 키의 개수이고 n은 슬롯 개수다.
* 안정 해시는 전통적 해시 테이블과 다르게 모듈로 연산(%)으로 대상을 탐색하지 않으며, Hash Ring을 만들어 링 위에서 첫번째 만나는 것을 대상으로 한다.
* 안정 해시 기본 구현법의 문제
  * 균등 분포 해시 함수를 사용 
  * 시계 방향 첫 번째의 서버를 지정하는 것 
  * 이 해시의 문제점은 균등 분포 해시 함수를 사용해도 해시 파티션(인접한 서버 사이의 해시 공간)의 크기를 균등하게 유지하는게 불가능 하다는 것과 이로 인해 키가 균등하게 분포되기 어렵다는 문제가 있다.
  * 이를 해결 하기 위해 가상노드(Virtual Node) or 복제(Replica)라 불리는 기법을 사용한다.

**가상 노드**
* 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
* 각 서버는 하나가 아닌 여러 개 파티션을 관리해야 한다.
* 키 위치로부터 시계 방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버 다.
* 가상 노드의 개수를 늘릴수록 표준 편차가 작아져서 데이터가 고르게 분포되기 때문에 키의 분포는 점점 더 균등해진다.
* 가상 노드의 개수를 늘리면 표준 편차가 줄어들지만 저장할 공간이 늘어나니 트레이드오프가 발생한다.

**안정 해시의 이점**
* 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다. 
* 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다, 
* 핫스팟(hotspot) 키 문제를 줄일 수 있다. 
  * 특정 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있는데, 안정해시는 데이터를 좀 더 균등하게 분배하므로 이런 문제 줄인다.