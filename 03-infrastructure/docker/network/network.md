## 가상 네트워크

* 서버 한대 안에서 여러 네트워크 구성

#### NAT
|공인IP주소| 공인포트번호 | 사설IP주소      | 사설포트번호 |
|----------|--------|-------------|--------|
|124.111.46.91| 10001  | 192.168.0.4 | 80     |
|124.111.46.91| 100012 | 192.168.0.5 | 5432   |

1. OutBound (내부 서버 -> 외부 서버)  
   * 출발지: 124.111.46.91:10001 
   * 도착지: 223.130.200.107

2. OutBound 응답 (외부 서버 -> 내부 서버)
   * 출발지: 223.130.200.107 
   * 도착지: 124.111.46.91.10001

3. InBound (외부 서버 -> 내부 서버)
   * 출발지: 223.130.200.107 
   * 도착지: 124.111.46.91.10001로 요청 전달

#### 포트포워딩
NAT는 혼란이 생길 수 있음: 외부 -> 사내망으로 요청을 보내는 경우 포트번호를 랜덤으로 사용하는 것보단 미리 지정하는 것이 자연스러움

|공인IP주소| 공인포트번호 | 사설IP주소      | 사설포트번호 |
|----------|--------|-------------|--------|
|124.111.46.91| 80     | 192.168.0.4 | 80     |
|124.111.46.91| 21     | 192.168.0.5 | 20021  |

#### 도커 설치 실행 시
1. 가상의 네트워크 브릿지 생성 
    * 브릿지는 172.17.0.1의 가상의 ip 주소 할당 
2. 컨테이너에 가상의 IP 할당 
   * 공유기에 연결된 기기 한 대에 사설 IP가 할당되는 것과 동일 
3. 컨테이너간의 통신 전달

SDN (Software Defined Network): 논리적으로 네트워크 환경을 구성


#### 동작 원리
1. 물리 인터페이스에 랜선을 연결해 IP 할당 
2. Host OS위에 Docker 설치하면 가상 인터페이스 하나 생성 
3. 컨테이너 실행시 각각 컨테이너에 해당하는 Veth라는 접두어로 Host Os에 가상 인터페이스들이 생성됨

* iptables: Linux 내부의 네트워크 트래픽 관리 및 제어 
  * Rule: 도착지가 172.17.0.3이면 Veth2 인터페이스로 전달
* 컨테이너 1개 당 Host머신에 가상의 Veth 인터페이스 1개 생성
* Docker가 iptables의 규칙을 수정하여 Veth 인터페이스의 트래픽 제어

```
docker network ls - 네트워크 리스트 조회
docker network inspect 네트워크명 - 네트워크 상세 정보 조회
docker network create 네트워크명 - 네트워크 생성
docker network rm 네트워크명 - 네트워크 삭제
```

#### 정리
도커는 컨테이너 통신을 위해 브릿지 네트워크를 정의하고 Host OS의 가상 인터페이스를 생성하고 Host OS의 iptables 규칙을 관리하면서 가상 인터페이스들간 통신 규칙을 생성한다.
-> 사용자는 별도의 설정을 하지 않아도 같은 브릿지 네트워크에서 생성된 컨테이너들은 통신 가능한 상태로 구성됨

```docker run -p HostOS의포트:컨테이너의 포트 - 포트포워딩 옵션```

브릿지 네트워크: 도커 브릿지를 활용해 컨테이너간 통신, NAT 및 포트포워딩 기술을 활용해 외부 통신 지원

호스트 네트워크: 호스트의 네트워크를 공유, 모든 컨테이너는 호스트 머신과 동일한 IP를 사용, 포트 중복 불가능

오버레이 네트워크: Kubernetes에서 사용, 호스트 머신이 다수일 때 네트워크 관리 기술

Macvlan 네트워크: 컨테이너에 MAC 주소를 할당하여 물리 네트워크 인터페이스에 직접 연결