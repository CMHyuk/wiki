## 네트워크 계층

### 데이터 링크 계층의 한계
- 데이터 & 물리 계층에서 언급한 네트워크 범위는 일반적으로 LAN으로 한정 
- LAN을 넘어 다른 네트워크와의 통신을 위한 네트워크 계층 
  - IP 주소를 통한 송수신지 대상을 지정 
  - 라우팅을 통한 다른 네트워크와 통신
- 물리 & 데이터 링크 계층만으로는 LAN을 넘어서 통신하기 어려움 
  - 다른 네트워크까지의 도달 경로를 파악하기 어려움 
    - 라우팅 - 패킷이 이동할 최적의 경로를 결정하는 것 
    - 라우터 - 라우팅을 수행하는 대표적인 장비
  - MAC 주소만으로는 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어려움 
    - MAC 주소와 IP 주소는 함께 사용되고, 기본적으로 IP 주소를 우선 활용

---

### 인터넷 프로토콜 (IP)  
- IP의 공식적인 두 기능 
  - 주소 지정 
    - IP 주소(IPv4 주소)를 바탕으로 송수신 대상을 지정하는 것을 의미 
    - 4바이트로 하나의 주소를 표현 
    - 숫자당 8비트로 표현 : 0 ~ 255 범위 안에 있는 네 개의 10진수로 표기 
    - 각 숫자는 점으로 구분 
    - 점으로 구분된 8비트를 옥텟이라 함 
    - ex) 192.168.1.1
- 단편화 
  - 전송하고자 하는 패킷의 크기를 MTU 이하의 복수의 패킷으로 나누는 것 
    - MTU(Maximum TransMission Unit)
      - 한 번에 전송 가능한 IP 패킷의 최대 크기 
      - IP 패킷의 헤더도 MTU 크기의 포함 
      - 일반적인 MTU 크기는 1500바이트, MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합

**단편화 피하기**
- 단편화, 많이 수행된느 것이 좋을까? 
  - IP 단편화는 되도록 하지 않는 것이 좋음 
  - 불필요한 트래픽 증가와 대역폭 낭비 
  - 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하도 성능 저하 요소
- IP 패킷을 주고받는 모든 노드가 **IP 단편화 없이 주고 받을 수 있는 최대 크기**만큼만 전송해야 함
- IP 단편화 없이 주고 받을 수 있는 최대 크기 = 경로 MTU(Path MTU)
  - 즉, 단편화를 피하는 방법은 경로 MTU만큼의 데이터를 전송하는 것 
  - 경로 MTU 발견(Path MTU discovery): 경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피
- 실제로도 단편화는 자주 일어나지 않음 
  - 대부분 DF(Don't Fragment) 비트가 세팅되어 있음

---

### IPv4

**패킷의 핵심 필드**  
- 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 송신지 수신지 IP 주소

**식별자**
- 패킷에 할당된 번호 
- 쪼개져서 도착한 IPv4 패킷들이 어떤 메시지에서 쪼개졌는지를 알기 위해 사용

**플래그: 세 개의 비트로 구성**
- 첫 번째 비트는 항상 0: 현재 사용되지 않음 
- DF 비트(Don't Fragment) - IP 단편화를 수행하지 말라는 표시 
  - 1이라면: "IP 단편화 수행하지 말라"
  - 0이라면: "IP 단편화 가능하다"
- MF 비트(More Fragment) - 단편화된 패킷이 더 있는지를 나타냄 
  - 1이라면: "쪼개진 패킷이 아직 더 있다"
  - 0이라면: "이 패킷이 마지막 패킷이다"

**단편화 오프셋**  
- 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타냄 
  - 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있음 
  - 수신지가 패킷들을 순서대로 재조합하려면 단편화된 패킷이 초기 데이터에서 몇 번째에 해당하는 패킷인지 알아야 함

**TTL**
- 패킷의 수명 
- 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위해 존재 
- 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소, TTL 값이 0으로 떨어진 패킷은 폐기 
- 홉 - 패킷이 호스트 또는 라우터에 한 번 전달되는 것 
  - 즉, TTL 필드의 값은 홉마다 1씩 감소

**프로토콜**
- 상위 계층의 프로토콜이 무엇인지를 나타내는 필드 
- 예) 전송 계층의 대표적인 프로토콜인 TCP는 6번, UDP는 17번

**송신지, 수신지 IP 주소**
- IP의 공식적인 기능 두 가지 중 하나인 **주소 지정**이 여기에 해당
- 이름 그대로 송수신지의 IPv4 주소

---

### IPv6

**IPv6**
- 이론적으로 할당 가능한 IPv4 주소 개수는 약 43억개 이므로 전 세계 인구가 하나씩 IP 주소를 가지고 있어도 부족한 숫자 
- IPv6는 16바이트로 주소를 표현할 수 있고, 콜론으로 구분된 8개 그룹의 16진수로 표기 
- 이론적으로 할당 가능한 IPv6 주소는 2의 128승개
  - ex) 2001:0db8:85a3:0000:0000:8a2e:0370:7334

**핵심 필드**  
- 다음 헤더 
  - 상위 계층의 프로토콜 또는 확장 헤더를 가리키는 필드 
  - 확장 헤더 
    - IPv6는 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있음 
    - 확장 헤더는 기본 헤더와 페이로드 데이터 사이에 위치 
    - 마치 꼬리에 꼬리를 물듯 또 다른 확장 헤더를 가질 수도 있음

- IPv6의 단편화
  - IPv6는 단편화 확장 헤더를 통해 단편화가 이루어짐 
    - 단편화 확장에도 **다음 헤더** 필드가 있음 
      - 예약됨과 예약 필드는 0으로 설정되어 사용되지 않음 
      - **단편화 오프셋과 M 플래그, 식별자 필드** 
        - 단편화 오프셋 - 전체 메시지에서 현재 단편화된 패킷의 위치 
        - M 플래그는 1일 경우 더 많은 단편화된 패킷이 있음을, 0일 경우 마지막 패킷 
        - 식별자는 동일한 메시지에서부터 단편화된 패킷임을 식별

---

### ARP

**ARP (Address Resolution Protocol)**  
- IP 주소를 통해 MAC 주소를 알아내는 프로토콜 
- 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아낼 수 있음 
- ARP 동작 
  1. ARP 요청 
  2. ARP 응답
  3. ARP 테이블 갱신

**MAC 주소를 알아내는 과정**  
- 동일 네트워크에 속한 호스트 A, B 
- 호스트 A는 호스트 B의 IP주소는 알지만 MAC 주소는 모름
 
1. ARP 요청 
   - 호스트 A: 브로드캐스트 메시지 전송 
   - 이 브로드캐스트 메시지 = ARP 요청이라는 ARP 패킷
2. ARP 응답 
   - 호스트 B 외에 나머지 호스트는 자신의 IP 주소가 아니므로 무시
   - 호스트 B: 자신의 MAC 주소를 담은 유니캐스트 메시지를 A에게 전송 
   - 이 유니캐스트 메시지 = ARP 응답이라는 ARP 패킷
     - 이 메시지를 수신한 A는 B의 MAC 주소를 알게 됨

3. ARP 테이블 갱신 
   - ARP 테이블: ARP 요청-응답을 통해 알게 된 IP 주소와 MAC 주소의 연관 관계 
     - ARP 테이블 항목은 일정 시간이 지나면 삭제, 임의 삭제도 가능 
     - ARP 테이블에 등록된 호스트에 대해선 ARP 요청을 보낼 필요 없음

**ARP 패킷?**
- ARP 요청, 응답 과정에서 송수신되는 패킷 
- 오퍼레이션 코드 - ARP 요청의 경우 1, ARP 응답의 경우 2 
- 송신지, 수신지 하드웨어 주소 
  - MAC 주소
- 송신지, 수신지 프로토콜 주소
  - IP 주소

---

### IP 주소의 구조와 클래스풀 주소체계

- 주소 지정은 IP 주소로 이루어짐 
- IP 주소의 구조: 크게 네트워크 주소와 호스트 주소로 구성 
  - 네트워크 주소가 16비트, 호스트 주소가 16비트인 IP주소 
    - 172.16.12.45 (10101100.00010000.00001100.00101101)
- 네트워크 주소 
  - 네트워크를 표현하는 부분 
  - 호스트가 속한 특정 네트워크를 식별
- 호스트 주소 
  - 호스트를 표현하는 부분 
  - 특정 호스트를 식별 

**IP 주소에서 네트워크 주소와 호스트 주소 크기는 각각 어느 정도가 적당할까?**
- 네트워크 주소가 하나의 옥텟으로 이루어질 경우 
  - 한 네트워크당 호스트 주소 할당에 24비트를 사용할 수 있음 
    - 상대적으로 많은 호스트에 IP 주소를 할당
- 네트워크 주소가 세 개의 옥텟으로 이루어질 경우 
  - 한 네트워크당 호스트 주소 할당에 8비트 사용할 수 있음 
    - 상대적으로 적은 호스트에 IP 주소를 할당

**IP 주소의 구조**  
- 무조건 호스트 주소 공간을 크게 할당하면? 
  - 호스트가 할당되지 않은 다수의 IP 주소가 낭비
- 무조건 호스트 주소 공간을 작게 할당하면? 
  - 호스트가 사용할 IP 주소가 부족  
- 이런 고민을 해결하기 위해 생겨난 개념 = IP 주소의 클래스

**클래스풀 주소 체계**  
- 클래스 
  - 네트워크 크기에 따라 IP 주소를 분류하는 기준 
  - 클래스풀 주소 체계 - 클래스를 기반으로 IP 주소를 관리하는 주소 체계 
  - 필요한 호스트 IP 개수에 따라 클래스를 달리 선택 - 네트워크 크기 조정 가능

- **A 클래스** 
  - B와 C 클래스에 비해 할당 가능한 호스트 주소의 수가 많음 
  - 네트워크 주소는 비트 0으로 시작하는 1옥텟, 호스트 주소는 3옥텟으로 구성 
  - 이론상 128개의 클래스 네트워크 존재 가능
  - A 클래스로 나타낼 수 있는 IP 주소 범위 
    - 최솟값을 10진수로 표현하면 0.0.0.0 
    - 최댓값을 10진수로 표현하면 127.255.255.255  
  - 가장 처음 옥텟의 주소가 0 ~ 127일 경우 A 클래스 주소임을 짐작할 수 있음
  - 각 네트워크에 2의24승 (16,777,216)개의 호스트 주소 할당 가능

- **B 클래스** 
  - 네트워크 주소는 비트 10으로 시작하는 2옥텟, 호스트 주소도 2옥텟으로 구성 
  - 이론상 2의 14승(16,384)개의 B 클래스 네트워크 존재 가능 
  - 각 네트워크에 2의16승(65,534)개의 호스트 주소 할당 가능 
  - B 클래스로 나타낼 수 있는 IP 주소 범위 
    - 최솟값을 10진수로 표현하면 128.0.0.0 
    - 최댓값을 10진수로 표현하면 191.255.255.255  
  - 가장 처음 옥텟의 주소가 128 ~ 191일 경우 B 클래스 주소임을 짐작할 수 있음

- **C 클래스**   
  - 네트워크 주소는 비트 110으로 시작하는 3옥텟, 호스트 주소는 1옥텟으로 구성 
  - 이론상 2의 21승개의 C 클래스 네트워크 존재 가능 
  - 각 네트워크에 2의8승(256)개 호스트 주소 할당 가능
  - C 클래스로 나타낼 수 있는 IP 주소 범위
    - 최솟값을 10진수로 표현하면 192.0.0.0 
    - 최댓값을 10진수로 표현하면 223.255.255.255
  - 가장 처음 옥텟의 주소가 192 ~ 223일 경우 C 클래스 주소임을 짐작할 수 있음

- **호스트의 주소 공간을 모두 사용할 수 있는 것은 아님**   
  - 호스트 주소가 전부 0인 IP 주소 
    - 해당 네트워크 자체를 의미하는 네트워크 주소로 사용 
  - 호스트 주소가 전부 1인 IP 주소 
    - 브로드캐스트 주소로 사용

---

**공인 IP 주소**
- 전 세계에서 고유한 IP 주소 
- 네트워크 간의 통신, 이를테면 인터넷을 이용할 때 사용하는 IP 주소 
- 공인 IP 주소는 ISP나 공인 IP 주소 할당 기관을 통해 할당  

**사설 IP 주소**  
- 사설 네트워크에서 사용하기 위한 IP 주소 
- 사설 IP 주소로 사용하도록 특별히 예약된 IP 주소 공간 
  - 10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
  - 172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
  - 192.168.0.0/16 (192.168.0.0 - 192.168.255.255) 
- 사설 IP 주소의 할당 주체는 일반적으로 라우터 (공유기)

**NAT (Network Address Translation)**  
- IP 주소 변환 기술: 주로 사설 IP 주소와 공인 IP 주소를 변환 
- 대부분의 라우터와 (가정용) 공유기는 NAT 기능 내장 
  - 사설 네트워크의 패킷 속 사설 IP 주소는 공유기를 거쳐 공인 IP 주소로 변경 
  - 외부 네트워크의 패킷 속 공인 IP 주소는 공유기를 거쳐 사설 IP 주소로 변경
- NAT를 통해 사설 IP 주소를 사용하는 여러 호스트는 적은 수의 공인 IP 주소를 공유 가능

---

### 정적 IP 주소 동적 IP 주소

**정적 IP 주소 부여**  
- 윈도우나 맥OS 등의 네트워크 설정에서 IP 주소를 수동으로 설정 
- 일반적으로 부여하고자 하는 IP 주소, 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소를 입력 

**기본 게이트웨이**   
- 게이트웨의 일반적 의미 
  - 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단
- 호스트가 속한 네트워크 외부로 나가기 위한 기본적인 첫 경로(첫 번째 홉)
  - 네트워크 외부와 연결된 라우터(공유기)의 주소를 의미하는 경우가 많음 
  - IP 할당의 맥락에서 사용된 '게이트웨이'라는 용어는 기본 게이트웨이(라우터(공유기)의 주소)를 의미

**모든 IP 주소를 정적으로 할당할 수 있을까?**
- 호스트의 수가 많아질 경우 관리 곤란 
- 의도치 않게 잘못된 IP 주소를 입력할 수도 있고, 중복된 IP 주소를 입력할 수도 있음

**동적 할당**
- 호스트에 IP 주소를 프로토콜을 활용해 자동으로 할당하는 방식 
  - IP 동적 할당에 사용되는 대표적인 프로토콜 DHCP(Dynamic Host Configuration Protocol)
- 이렇게 할당된 IP 주소를 동적 IP 주소라고 함