## 네트워크 계층

### 데이터 링크 계층의 한계
- 데이터 & 물리 계층에서 언급한 네트워크 범위는 일반적으로 LAN으로 한정 
- LAN을 넘어 다른 네트워크와의 통신을 위한 네트워크 계층 
  - IP 주소를 통한 송수신지 대상을 지정 
  - 라우팅을 통한 다른 네트워크와 통신
- 물리 & 데이터 링크 계층만으로는 LAN을 넘어서 통신하기 어려움 
  - 다른 네트워크까지의 도달 경로를 파악하기 어려움 
    - 라우팅 - 패킷이 이동할 최적의 경로를 결정하는 것 
    - 라우터 - 라우팅을 수행하는 대표적인 장비
  - MAC 주소만으로는 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어려움 
    - MAC 주소와 IP 주소는 함께 사용되고, 기본적으로 IP 주소를 우선 활용

---

### 인터넷 프로토콜 (IP)  
- IP의 공식적인 두 기능 
  - 주소 지정 
    - IP 주소(IPv4 주소)를 바탕으로 송수신 대상을 지정하는 것을 의미 
    - 4바이트로 하나의 주소를 표현 
    - 숫자당 8비트로 표현 : 0 ~ 255 범위 안에 있는 네 개의 10진수로 표기 
    - 각 숫자는 점으로 구분 
    - 점으로 구분된 8비트를 옥텟이라 함 
    - ex) 192.168.1.1
- 단편화 
  - 전송하고자 하는 패킷의 크기를 MTU 이하의 복수의 패킷으로 나누는 것 
    - MTU(Maximum TransMission Unit)
      - 한 번에 전송 가능한 IP 패킷의 최대 크기 
      - IP 패킷의 헤더도 MTU 크기의 포함 
      - 일반적인 MTU 크기는 1500바이트, MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합

---

### IPv4

**패킷의 핵심 필드**  
- 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 송신지 수신지 IP 주소

**식별자**
- 패킷에 할당된 번호 
- 쪼개져서 도착한 IPv4 패킷들이 어떤 메시지에서 쪼개졌는지를 알기 위해 사용

**플래그: 세 개의 비트로 구성**
- 첫 번째 비트는 항상 0: 현재 사용되지 않음 
- DF 비트(Don't Fragment) - IP 단편화를 수행하지 말라는 표시 
  - 1이라면: "IP 단편화 수행하지 말라"
  - 0이라면: "IP 단편화 가능하다"
- MF 비트(More Fragment) - 단편화된 패킷이 더 있는지를 나타냄 
  - 1이라면: "쪼개진 패킷이 아직 더 있다"
  - 0이라면: "이 패킷이 마지막 패킷이다"

**단편화 오프셋**  
- 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타냄 
  - 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있음 
  - 수신지가 패킷들을 순서대로 재조합하려면 단편화된 패킷이 초기 데이터에서 몇 번째에 해당하는 패킷인지 알아야 함

**TTL**
- 패킷의 수명 
- 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위해 존재 
- 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소, TTL 값이 0으로 떨어진 패킷은 폐기 
- 홉 - 패킷이 호스트 또는 라우터에 한 번 전달되는 것 
  - 즉, TTL 필드의 값은 홉마다 1씩 감소

**프로토콜**
- 상위 계층의 프로토콜이 무엇인지를 나타내는 필드 
- 예) 전송 계층의 대표적인 프로토콜인 TCP는 6번, UDP는 17번

**송신지, 수신지 IP 주소**
- IP의 공식적인 기능 두 가지 중 하나인 **주소 지정**이 여기에 해당
- 이름 그대로 송수신지의 IPv4 주소

---

### IPv6

**IPv6**
- 이론적으로 할당 가능한 IPv4 주소 개수는 약 43억개 이므로 전 세계 인구가 하나씩 IP 주소를 가지고 있어도 부족한 숫자 
- IPv6는 16바이트로 주소를 표현할 수 있고, 콜론으로 구분된 8개 그룹의 16진수로 표기 
- 이론적으로 할당 가능한 IPv6 주소는 2의 128승개
  - ex) 2001:0db8:85a3:0000:0000:8a2e:0370:7334

**핵심 필드**  
- 다음 헤더 
  - 상위 계층의 프로토콜 또는 확장 헤더를 가리키는 필드 
  - 확장 헤더 
    - IPv6는 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있음 
    - 확장 헤더는 다음 쪽의 그림처럼 기본 헤더와 페이로드 데이터 사이에 위치 
    - 마치 꼬리에 꼬리를 물듯 또 다른 확장 헤더를 가질 수도 있음

- IPv6의 단편화
  - IPv6는 단편화 확장 헤더를 통해 단편화가 이루어짐 
    - 단편화 확장에도 **다음 헤더** 필드가 있음 
      - 예약됨과 예약 필드는 0으로 설정되어 사용되지 않음 
      - **단편화 오프셋과 M 플래그, 식별자 필드** 
        - 단편화 오프셋 - 전체 메시지에서 현재 단편화된 패킷의 위치 
        - M 플래그는 1일 경우 더 많은 단편화된 패킷이 있음을, 0일 경우 마지막 패킷 
        - 식별자는 동일한 메시지에서부터 단편화된 패킷임을 식별

---

**공인 IP 주소**
- 전 세계에서 고유한 IP 주소 
- 네트워크 간의 통신, 이를테면 인터넷을 이용할 때 사용하는 IP 주소 
- 공인 IP 주소는 ISP나 공인 IP 주소 할당 기관을 통해 할당  

**사설 IP 주소**  
- 사설 네트워크에서 사용하기 위한 IP 주소 
- 사설 IP 주소로 사용하도록 특별히 예약된 IP 주소 공간 
  - 10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
  - 172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
  - 192.168.0.0/16 (192.168.0.0 - 192.168.255.255) 
- 사설 IP 주소의 할당 주체는 일반적으로 라우터 (공유기)

**NAT (Network Address Translation)**  
- IP 주소 변환 기술: 주로 사설 IP 주소와 공인 IP 주소를 변환 
- 대부분의 라우터와 (가정용) 공유기는 NAT 기능 내장 
  - 사설 네트워크의 패킷 속 사설 IP 주소는 공유기를 거쳐 공인 IP 주소로 변경 
  - 외부 네트워크의 패킷 속 공인 IP 주소는 공유기를 거쳐 사설 IP 주소로 변경
- NAT를 통해 사설 IP 주소를 사용하는 여러 호스트는 적은 수의 공인 IP 주소를 공유 가능